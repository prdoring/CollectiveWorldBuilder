<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collective World Builder</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background-color: #121212;
            color: white;
        }
        .container {
            display: flex;
            height: 90vh;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            padding-top: 2%;
        }
        .conversations, .chat {
            padding: 20px;
            overflow-y: auto;
        }
        /* Styling for conversation list */
        .conversations {
            background-color: #242424; /* Slightly adjusted for modern look */
            width: 50%;
            border-radius: 10px; /* Smoother rounded corners */
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5); /* Subtle shadow */
            transition: all 0.3s ease;
            z-index: 0;
        }
        /* Chat area styling */
        .chat {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #181818; /* Slightly adjusted for modern look */
            max-width: 80%;
            border-radius: 10px; /* Smoother rounded corners */
            margin-left: -10px;
            z-index: 1;
        }

        /* Chat title styling */
        .chatTitle {
            font-size: 1.5em;
            margin: -20px 0 10px 0; /* Adjusted margin for alignment */
            z-index: 3;
            color: #ffffff;
            background-color: #333333;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        #messages {
            list-style-type: none;
            padding: 0;
            overflow-y: auto;
            margin-top:20px;
            margin-bottom: 0;
            flex-grow: 1;
        }
        /* Message input area styling */
        .message-input {
            display: flex;
            margin-top: auto;
            background-color: #333;
            padding: 10px;
            border-radius: 5px; /* Adjusted for a sleeker look */
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5); /* Subtle inner shadow */
        }
        /* Input field styling */
        .message-input input[type="text"] {
            flex-grow: 1;
            margin-right: 10px;
            background-color: #444; /* Slightly lighter for contrast */
            border: none;
            color: white;
            padding: 10px;
            border-radius: 5px; /* Adjusted for sleek look */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.25); /* Subtle shadow for depth */
        }
        /* Send button styling */
        .btn.btn-primary {
            border: none;
            background-image: linear-gradient(to right, #0062E6, #33AEFF); /* Modern gradient */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5); /* Subtle shadow for depth */
            transition: background-color 0.3s ease; /* Smooth transition for hover effect */
        }

        /* Adjustments for send button on hover */
        .btn.btn-primary:hover {
            background-image: linear-gradient(to right, #004DBF, #007BFF); /* Darker gradient for hover */
        }
        
        .conversations ul {
            list-style-type: none;
            padding: 0;
        }
        .conversations li {
            cursor: pointer;
            padding: 10px;
            border-radius: 5px;
            background-color: #333;
            margin-bottom: 5px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        .conversations li:hover, .conversations li.active {
            background-color: #007bff;
            transform: translateX(5px);
        }

        .external-link::after {
            content: " ↗";
            font-size: smaller;
        }

        .message-bubble {
            padding: 10px 20px;
            border-radius: 20px; /* Smoother rounded corners */
            margin-bottom: 10px;
            max-width: 80%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); /* Lighter shadow for subtlety */
            color: #f1f1f1; /* Light color for text */
            transform: scale(0.5);
            animation: popIn 0.5s forwards;
        }
        /* User message styling */
        .user-message {
            background-image: linear-gradient(to top right, #0099FF, #19c6ff); /* Gradient for user messages */
            margin-left: auto;
            border-bottom-right-radius: 0;
        }

        /* Server message styling */
        .server-message {
            background-image:linear-gradient(to bottom left, #404040, #1f1f1f); /* Slightly lighter for contrast */
            color: #ddd; /* Light color for text */
            border-bottom-left-radius: 0;
        }
        .message-wrapper {
            display: flex;
            margin-bottom: 10px;
        }
        #messages {
            padding: 10px;
        }

        /* New Conversation Form Styles */
        #newConversationForm {
            align-items: center;
            margin-bottom: 20px; /* Add some space between the form and the conversation list */
            margin-top: 20px;
            background-image:linear-gradient(to bottom left, #404040, #1f1f1f); /* Slightly lighter for contrast */
            border-radius: 10px;
            padding: 10px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        #newConversationForm input[type="text"] {
            flex-grow: 1;
            margin: 3px;
            margin-bottom: 0px;
            background-color: #333;
            border: 1px solid #444;
            width: 100%;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.25);
            transition: all 0.3s ease;
        }

        #newConversationForm input[type="text"]:focus {
            background-color: #444; /* Slightly lighter on focus */
            outline: none; /* Remove the default focus outline */
            width:100%;
            border-color: #555;
        }

        #newConversationForm button {
            margin: 3px;
            margin-top: 0px;
            padding: 10px 15px;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width:100%;

            border: none;
            background-image: linear-gradient(to right, #0062E6, #33AEFF); /* Modern gradient */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5); /* Subtle shadow for depth */
            transition: background-color 0.3s ease; /* Smooth transition for hover effect */
        }

        #newConversationForm button:hover{
            background-image: linear-gradient(to right, #004DBF, #007BFF); /* Darker gradient for hover */
        }

        #newConversationForm button:hover {
            background-color: #0056b3; /* Darker shade on hover */
        }

        #newConversationForm button:disabled {
            background-color: #555; /* Grayed out when disabled */
            box-shadow: none;
        }

        .conversations.collapsed {
            width: 15px;
            overflow: hidden;
            transition: width 0.3s ease;
        }

        .hamburger-menu {
            margin-top: -10px;
            margin-left: -10px;
        }

        .dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: white;
            animation: bounce 1.4s infinite both;
            margin: 0 4px;
        }

        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }


        /* Adjust container width when conversations section is collapsed */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .conversations {
                width: 100%; /* Take the full width */
                max-width: none; /* Remove max-width restriction */
                height: auto;
                min-height: 80%;
                padding:12px;
                transition: 0.3s ease; /* Disable transition for height */
            }
            .conversations.collapsed {
                height: 60px;
                min-height: 0;
                width: 100%;
                overflow: hidden;
                transition: 0.3s ease;
            }
            .chat {
                max-width: 100%; /* Adjust chat width when conversations section is collapsed */
                margin-left:0;
                margin-top:-5px;
            }

            .hamburger-menu {
                margin-top: -10px;
                text-align: center;
            }
        }



        @keyframes popIn {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Custom scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px; /* Width of the scrollbar */
        }

        /* Track */
        ::-webkit-scrollbar-track {
            background: transparent; /* Color of the track */
        }

        /* Handle */
        ::-webkit-scrollbar-thumb {
            background: #888; /* Color of the handle */
            border-radius: 4px; /* Rounded corners */
        }

        /* Handle on hover */
        ::-webkit-scrollbar-thumb:hover {
            background: #555; /* Color of the handle on hover */
        }



    </style>
</head>
<body>

<div class="container">
    <div class="conversations">
        <div class="hamburger-menu">
            ☰ 
        </div>
        <hr/>
        <ul id="conversationList">
            <!-- Conversations will be listed here -->
        </ul>
        <form id="newConversationForm">
            <input type="text" id="newConversationName" placeholder="New Character" required>
            <br/>
            <button type="submit">Create</button>
            <a href="/overview" target="_blank" class="external-link">Need Context? City Overview</a>

        </form>
    </div>
    <div class="chat">
        <div class="chatTitle" id="chatTitle"></div>
        <ul id="messages"></ul>
        <div id="typingIndicator" style="display: none; text-align: center; padding: 10px;">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
        <div class="message-input">
            <input type="text" id="messageInput" autocomplete="off" placeholder="Type a message..." disabled>
            <button class="btn btn-primary" onclick="sendMessage()" disabled>Send</button>
        </div>
        
    </div>
</div>

<script>
var socket = io();
var user = ""
document.getElementById('messageInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});
var currentConversationId = null;

document.getElementById('newConversationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    var name = document.getElementById('newConversationName').value.trim();
    if (name) {
        socket.emit('create_conversation', {name: name});
        document.getElementById('newConversationName').value = ''; // Clear input
    }
});

document.getElementById('newConversationName').addEventListener('input', function() {
    // Get the input field and button
    var input = document.getElementById('newConversationName');
    var button = document.querySelector('#newConversationForm button');

    // Disable the button if the input is empty, enable it otherwise
    button.disabled = !input.value.trim();
});

// Initially disable the button since the input is empty on load
document.querySelector('#newConversationForm button').disabled = true;


socket.on('conversation_created_all', function(data) {
    var conversationList = document.getElementById('conversationList');
    var newConversation = document.createElement('li');
    newConversation.textContent = data.name;
    newConversation.setAttribute('onclick', `joinConversation('${data.name}')`);
    newConversation.id = data.name;
    conversationList.appendChild(newConversation);
});

socket.on('conversation_created', function(data) {
    joinConversation(data.name); // Auto-select the newly created conversation
});


function joinConversation(conversationId) {
    if (currentConversationId) {
        socket.emit('leave_conversation', {conversation_id: currentConversationId});
    }
    document.querySelectorAll('.conversations li').forEach(li => {
        li.classList.remove('active');
    });
    var selectedConversation = document.getElementById(conversationId);
    if (selectedConversation) {
        selectedConversation.classList.add('active');
    }
    currentConversationId = conversationId;
    socket.emit('join_conversation', {conversation_id: conversationId});
    document.getElementById('messages').innerHTML = ''; // Clear current messages
    document.getElementById('messageInput').disabled = false;
    document.querySelector('.btn.btn-primary').disabled = false;
    document.getElementById('chatTitle').innerHTML = conversationId
    document.querySelector('.conversations').classList.toggle('collapsed');
}


function sendMessage() {
    var messageInput = document.getElementById('messageInput');
    var sendButton = document.querySelector('.btn.btn-primary');
    var message = messageInput.value.trim();
    if (!message) return;

    // Disable the message input and send button immediately after sending a message
    messageInput.disabled = true;
    sendButton.disabled = true;
    document.getElementById('typingIndicator').style.display = 'block';

    // Send the message to the server
    socket.emit('send_message', {message: message, conversation_id: currentConversationId, user_id: user});

    // Clear the message input field
    messageInput.value = '';
}

socket.on('connect', function() {
    // No need to do anything here for now, the server will automatically send existing conversations
});

socket.on('existing_conversations', function(conversations) {
    var conversationList = document.getElementById('conversationList');
    conversationList.innerHTML = ''; // Clear the list before adding
    conversations.forEach(function(conversation) {
        var newConversation = document.createElement('li');
        newConversation.textContent = conversation.name;
        newConversation.setAttribute('onclick', `joinConversation('${conversation.name}')`);
        newConversation.id = conversation.name;
        conversationList.appendChild(newConversation);
    });
});


socket.on('conversation_history', function(data) {
    var messages = document.getElementById('messages');
    user = data.user
    messages.innerHTML = ''; // Clear existing messages
    data.history.forEach(function(message) {
        displayMessage(message); // Pass the whole message object
    });
});

socket.on('broadcast_message', function(data) {
    if (data.conversation_id === currentConversationId) {
        displayMessage(data.message); // Pass the whole message object
    }
});

socket.on('welcome_message', function(data) {
    
    if (currentConversationId==null) {
        displayWelcomeMessage(data.message); // Pass the whole message object
    }
});

function displayMessage(messageData, senderOverride) {
    var messages = document.getElementById('messages');
    var wrapper = document.createElement('div');
    wrapper.classList.add('message-wrapper');

    var newMessage = document.createElement('div');
    // Adjust this line to use messageData.text
    newMessage.textContent = messageData.text || messageData; // Fallback to messageData if .text is not available
    newMessage.classList.add('message-bubble');
    // Use senderOverride if provided, else fall back to messageData.sender
    var sender = senderOverride || messageData.sender;
    if (sender === 'user') {
        newMessage.classList.add('user-message');
    } else {
        newMessage.classList.add('server-message');
                
        // Re-enable the message input and send button
        document.getElementById('messageInput').disabled = false;
        document.querySelector('.btn.btn-primary').disabled = false;
        document.getElementById('typingIndicator').style.display = 'none';
    }

    wrapper.appendChild(newMessage);
    messages.appendChild(wrapper);
    messages.scrollTop = messages.scrollHeight;
}

function displayWelcomeMessage(message){
    var messages = document.getElementById('messages');
    var wrapper = document.createElement('div');
    wrapper.classList.add('message-wrapper');

    var newMessage = document.createElement('div');
    // Adjust this line to use messageData.text
    newMessage.innerHTML = message
    newMessage.classList.add('message-bubble');
    newMessage.classList.add('server-message');
    wrapper.appendChild(newMessage);
    messages.appendChild(wrapper);
    document.getElementById('typingIndicator').style.display = 'none';
}


// You might also want a function to handle leaving a conversation or when no conversation is selected
function handleNoConversationSelected() {
    document.getElementById('messageInput').disabled = true;
    document.querySelector('.btn.btn-primary').disabled = true;
}

// Initially, no conversation is selected, so inputs are disabled
handleNoConversationSelected();


document.addEventListener('DOMContentLoaded', function() {
    var hamburgerMenu = document.querySelector('.hamburger-menu');
    var conversationsSection = document.querySelector('.conversations');

    hamburgerMenu.addEventListener('click', function() {
        conversationsSection.classList.toggle('collapsed');
    });
    displayWelcomeMessage("<h2>Welcome!</h2><br/>To get started make a character and get to talking!  If you are looking for inspiration wait here and you will be given a list of the top things the interviewer wants to know!<br/>")
    socket.emit('request_welcome_message',{});
});

</script>
    

</body>
</html>
